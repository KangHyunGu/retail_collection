<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RSSI Line Chart with Tabs (jQuery)</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            margin: 20px;
            gap: 20px;
        }
        .tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            background-color: #f4f4f4;
        }
        .tab.active {
            background-color: #ddd;
            font-weight: bold;
        }
        .content-container {
            display: none;
            width: 100%;
        }
        .content-container.active {
            display: block;
        }
        .chart-container, .controls-container {
            margin: 0 auto;
            width: 80%;
        }
        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            justify-content: center;
        }
        .checkbox-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }
        canvas {
            max-width: 100%;
            margin: 20px 0;
            max-height: 550px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        table, th, td {
            border: 1px solid #ddd;
        }
        th, td {
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #f4f4f4;
        }
        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="tabs">
            <div class="tab active" data-target="#chartContainer">분포도</div>
            <div class="tab" data-target="#tableContainer">테이블</div>
        </div>

        <div class="controls">
            <select id="storeSelect">
                <option value="원체크2">원체크2</option>
                <option value="본가왕뼈">본가왕뼈</option>
                <option value="GS25 안양 skv1 2차">GS25 안양 skv1 2차</option>
                <option value="뮤피">뮤피</option>
                <option value="이마트 편의점 금정역2차">이마트 편의점 금정역2차</option>
                <option value="스타벅스 호계지식산업센터">스타벅스 호계지식산업센터</option>
                <option value="포메인레드 호계점">포메인레드 호계점</option>
                <option value="GS25 호계 데시앙">GS25 호계 데시앙</option>
            </select>
            <select id="deviceTypeSelect">
                <option value="BLE">BLE</option>
                <option value="WIFI">WIFI</option>
            </select>
        </div>

        <div class="checkbox-section">
            <div>
                <input type="checkbox" id="selectAll" />
                <label for="selectAll">전체 선택</label>
            </div>
            <div id="deviceCheckboxes" class="checkbox-grid"></div>
        </div>

        <div id="chartContainer" class="content-container active">
            <canvas id="lineChart"></canvas>
        </div>

        <div id="tableContainer" class="content-container">
            <h3>Selected Device Data</h3>
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>Device</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        const allData = {};
        let lineChart;
        let selectedDevices = [];
        let apiUrl = '';

        function groupDataByStoreAndDevice(data) {
            const groupedData = {};
            data.forEach(item => {
                const key = `${item.col_store_nm}_${item.col_store_device_nm}_${item.col_store_device_mac_addr}`;
                if (!groupedData[key]) {
                    groupedData[key] = {
                        store: item.col_store_nm,
                        device: item.col_store_device_nm,
                        macAddr: item.col_store_device_mac_addr,
                        type: item.col_store_device_type,
                        rssi: [],
                    };
                }
                groupedData[key].rssi.push(item.col_store_device_rssi);
            });
            return Object.values(groupedData);
        }

        function fetchData(store) {
            $.getJSON(`/api/spread?store=${store}`, (responseData) => {
                const groupedData = groupDataByStoreAndDevice(responseData);
                allData[store] = groupedData; // 특정 매장 데이터만 저장
                initialize();
            }).fail((error) => {
                console.error("Error fetching data:", error);
            });
        }

        function updateChart(store, deviceType) {
            const storeData = allData[store] || [];
            const filteredData = storeData.filter(device => device.type === deviceType);

            const datasets = filteredData
                .filter(device => selectedDevices.includes(device.device))
                .map((item, index) => ({
                    label: `${item.device} (${item.macAddr})`,
                    data: item.rssi.map((value, timeIndex) => ({ x: timeIndex + 1, y: value })),
                    borderColor: `hsl(${index * 20}, 70%, 50%)`,
                    backgroundColor: `hsl(${index * 20}, 70%, 50%, 0.3)`,
                    tension: 0.4,
                    fill: false,
                }));

            if (lineChart) lineChart.destroy();

            lineChart = new Chart($("#lineChart"), {
                type: "line",
                data: { datasets },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: "left" },
                        title: { display: true, text: `RSSI Line Chart for ${store} (${deviceType})` },
                    },
                    scales: {
                        x: {
                            type: "linear",
                            title: { display: true, text: "Time Index" },
                            ticks: { stepSize: 1 },
                        },
                        y: {
                            title: { display: true, text: "RSSI Value" },
                            suggestedMin: -70,
                            suggestedMax: -40,
                        },
                    },
                },
            });
            populateTable(storeData, deviceType);
        }
        function createDeviceCheckboxes(storeData, deviceType) {
            const $deviceCheckboxes = $("#deviceCheckboxes");
            $deviceCheckboxes.empty();

            const filteredData = storeData.filter(device => device.type === deviceType);
            selectedDevices = filteredData.map(device => device.device);

            filteredData.forEach(device => {
                const $checkbox = $(`<input type="checkbox" id="${device.device}" value="${device.device}" checked>`);

                $checkbox.on("change", function () {
                    if (this.checked) {
                        selectedDevices.push(device.device);
                    } else {
                        selectedDevices = selectedDevices.filter(d => d !== device.device);
                    }
                    updateChart($("#storeSelect").val(), $("#deviceTypeSelect").val());
                });

                const $label = $(`<label for="${device.device}">${device.device} (${device.macAddr})</label>`);

                const $container = $("<div></div>").append($checkbox, $label);
                $deviceCheckboxes.append($container);
            });
        }

        function populateTable(storeData, deviceType) {
            const filteredData = storeData.filter(device => device.type === deviceType);
            const $tableHead = $("#dataTable thead tr");
            const $tableBody = $("#dataTable tbody");

            // 가장 긴 데이터 배열 길이 계산
            const maxTimeIndex = Math.max(...filteredData.map(device => device.rssi.length));

            // 테이블 헤더 생성
            $tableHead.html("<th>Device</th>");
            for (let i = 1; i <= maxTimeIndex; i++) {
                $tableHead.append(`<th>${i}</th>`);
            }
            $tableHead.append("<th>최소 값</th>");
            $tableHead.append("<th>최대 값</th>");
            $tableHead.append("<th>최소 이동 변화량</th>");
            $tableHead.append("<th>평균 이동 변화량</th>");
            $tableHead.append("<th>최대 이동 변화량</th>");
            $tableHead.append("<th>평균 RSSI</th>");
            $tableHead.append("<th>RANK</th>");

            // 평균 RSSI 계산 및 그룹화
            const groupedData = {};
            filteredData.forEach(device => {
                const key = `${device.device}_${device.macAddr}`;
                if (!groupedData[key]) {
                    groupedData[key] = {
                        device: device.device,
                        macAddr: device.macAddr,
                        rssi: [],
                    };
                }
                groupedData[key].rssi = groupedData[key].rssi.concat(device.rssi.filter(rssi => rssi !== undefined && rssi !== ""));
            });

            const deviceData = Object.values(groupedData).map(device => {
                const avgRSSI = device.rssi.length
                    ? (device.rssi.reduce((sum, value) => sum + value, 0) / device.rssi.length).toFixed(2)
                    : "없음";
                return { ...device, avgRSSI: avgRSSI === "없음" ? null : parseFloat(avgRSSI) };
            });

            // RANK 계산 (평균 RSSI 내림차순, 동순위 처리)
            deviceData.sort((a, b) => b.avgRSSI - a.avgRSSI);
            let rank = 1;
            deviceData.forEach((device, index) => {
                if (index > 0 && device.avgRSSI !== deviceData[index - 1].avgRSSI) {
                    rank = index + 1;
                }
                device.rank = rank;
            });

            // RANK 기준 정렬
            deviceData.sort((a, b) => a.rank - b.rank);

            // 테이블 데이터 추가
            $tableBody.empty();
            deviceData.forEach(device => {
                const key = `${device.device}_${device.macAddr}`;
                const groupedDevice = groupedData[key];

                const $row = $(`<tr><td>${device.device} (${device.macAddr})</td></tr>`);
                let rssiValues = groupedDevice.rssi;

                // RSSI 데이터 추가
                for (let i = 0; i < maxTimeIndex; i++) {
                    const value = rssiValues[i] !== undefined ? rssiValues[i] : "";
                    $row.append(`<td>${value}</td>`);
                }

                // 최소 값 및 최대 값 계산
                const minValue = rssiValues.length ? Math.min(...rssiValues) : "없음";
                const maxValue = rssiValues.length ? Math.max(...rssiValues) : "없음";

                // 이동 변화량 계산
                let changes = [];
                for (let i = 1; i < rssiValues.length; i++) {
                    const change = Math.abs(rssiValues[i] - rssiValues[i - 1]);
                    if (change >= 1) {
                        changes.push(change); // 1 이상만 포함
                    }
                }

                const minChange = changes.length ? Math.min(...changes) : "없음";
                const avgChange = changes.length ? (changes.reduce((a, b) => a + b, 0) / changes.length).toFixed(2) : "없음";
                const maxChange = changes.length ? Math.max(...changes) : "없음";

                // 최소 값, 최대 값 추가
                $row.append(`<td>${minValue}</td>`);
                $row.append(`<td>${maxValue}</td>`);

                // 이동 변화량 및 기타 값 추가
                $row.append(`<td>${minChange}</td>`);
                $row.append(`<td>${avgChange}</td>`);
                $row.append(`<td>${maxChange}</td>`);
                $row.append(`<td>${device.avgRSSI}</td>`);
                $row.append(`<td>${device.rank}</td>`);

                // RANK에 따른 색상 지정
                if (device.rank === 1 || device.rank === 2) {
                    $row.css("background-color", "lightgreen");
                } else if (device.rank === 3 || device.rank === 4) {
                    $row.css("background-color", "orange");
                } else if (device.rank === 5) {
                    $row.css("background-color", "lightblue");
                }

                $tableBody.append($row);
            });
        }

        function initialize() {
            const selectedStore = $("#storeSelect").val();
            const selectedDeviceType = $("#deviceTypeSelect").val();
            const storeData = allData[selectedStore] || [];
            createDeviceCheckboxes(storeData, selectedDeviceType);
            updateChart(selectedStore, selectedDeviceType);
        }

        $(document).ready(function () {
            $(".tabs .tab").on("click", function () {
                const target = $(this).data("target");
                $(".tabs .tab").removeClass("active");
                $(this).addClass("active");
                $(".content-container").removeClass("active");
                $(target).addClass("active");
            });

            $("#storeSelect").on("change", function () {
                const selectedStore = $(this).val();
                fetchData(selectedStore); // 매장 변경 시 데이터 로드
            });

            $("#deviceTypeSelect").on("change", initialize);

            $("#selectAll").on("change", function () {
                const isChecked = this.checked;
                $("#deviceCheckboxes input[type=checkbox]").prop("checked", isChecked);
                selectedDevices = isChecked ? $("#deviceCheckboxes input[type=checkbox]").map(function () { return this.value; }).get() : [];
                updateChart($("#storeSelect").val(), $("#deviceTypeSelect").val());
            });

            

            fetchData($("#storeSelect").val()); // 초기 데이터 로드
        });
    </script>
</body>
</html>
